# 为什么我建立的索引失效乐-优化器成本计算原理

## 优化器的功能

1. 不改变语义的情况下，重写SQL。重写后的SQL更简单，更方便制定执行计划
2. 根据成本分析，指定执行计划

## 语句重写

对于一些执行起来十分耗费性能的语句，MySQL 还是依据一些规则，竭尽全力的把这个很糟糕的语句转换成某种可以比较高效执行的形式，这个过程叶可以被称为查询重写

### 条件化简

我们编写的查询语句的搜索条件本质上是一个表达式，这些表达式可能比较繁杂，或者不能高效的执行，MySQL 的查询优化器会为我们简化这些表达式

#### 移除不必要的括号

有时候表达式里有许多无用的括号，比如这样一条 SQL：

    ((a = 5 AND b = c) OR ((a > c) AND (c < 5)))

优化器就会对其进行优化成这样：

    (a = 5 AND b =c) OR (a > c AND c < 5)

#### 常量传递

#### 等值传递

#### 移除没用的条件

#### 表达式计算

#### 常量表检测

#### 外连接消除

内连接与外连接的区别

如何使外连接可以让优化

## MySQL 成本分析

一条 MySQL 执行有两方面的成本需要考虑：IO 成本和 CPU 成本 

IO 成本：这个从磁盘到内存的加载过程损耗的时间

CPU 成本：读取记录以及检测记录是否满足对应的搜索条件、对结果集进行排序等这些操作损耗的时间称为 CPU 成本 

### 基于成本的优化步骤

在真正执行一条单表查询语句之前，MySQL 的优化器会找出所有可以用来执行语句的方案，并在对比这些方案之后找出成本最低的方案。这个成本最低的方案就是所谓的执行计划，之后才会调用存储引擎提供的接口真正地执行查询，这个过程总结一下就是下面这样：

1. 根据搜索条件，找出所有可能使用的索引
2. 计算全表扫描的代价
3. 计算使用不同索引执行查询的代价
4. 对比各种执行方案的代价，找出成本最低的那个方案