# 分布式数据库集群与中间件

其实一般情况下没必要做分布式集群，除非数据量特别特别大，比如电商、网易云音乐、微博、快递业务

## 分布式数据库特点

优点

* 可用性提高
* 可扩展性提升 ？？？
* 某些情况下吞吐率提升显著 ？？？

缺点

* 依赖中间件
* SQL语句支持不足
* 运维复杂度提高
* 某些情况下性能下降巨大

## 分布式数据库存在的问题罗列

不是原来一台机器扩成八台机器性能就会提升八倍这么简单

只有在某些情况下性能提升巨大的，但是很有可能在大部分场景之下对于你的业务性能下降是巨大的

扩节点的时候比如四扩八，八扩十二所有数据都需要打散一遍，数据量大的时候表又很多的时候怎么打散？

类似 Mongodb 的分片策略会更好，通常来说也是未来比较好的一种模式，但是这种方式在关系数据库中相对很难实现，会涉及到 MySQL 内核、中间件的改造，代价太大了

数据库做分布式一种是在业务层做，一种是在中间件做，如果用中间件做基本上业界并没有什么好的中间件，MyCat 这种可以用但是在生产环境还是不建议用

SQL 支持不足，在一台机器上像怎么写就怎么写，但是上了中间件支持的 SQL 有限，对 Join、复杂子查询的支持有限

不要迷信所谓的分布式数据库，不要迷信所谓的分库分表，没有太大的好处

## 分片和分区的区别

相同：打算数据

不同：打散的数据**可能**不在同一个实例上

分片的实现**非常复杂**！！！

## 分区键

CREATE TABLE employees (
  id INT NOT NULL,
  fname VARCHAR(30),
  lname VARCHAR(30),
  hired DATE NOT NULL DEFAULT '1970-01-01',
  separated DATE NOT NULL DEFAULT '9999-12-32',
  job_code INT,
  store_id INT
)
PARTITION BY HASH(id)  # id是分区键
PARTITIONS 4;

* 更改分布式数据库中的分区键非常麻烦
* 必须一开始就规划好表的分区键
* 尽可能大部分的业务逻辑都是根据该分区键
  * 根据均衡字段进行访问的SQL语句至少要占到80%，不然全表都要访问一遍性能很差丧失了所谓的扩展性

原则1：如果不能选择有效的分区键，这张表就不要进行分片，作为**全局表**

原则2：如果业务选择不出有效率的分区键，那么进行分布式数据的改造也将是徒劳的

对于数据库分库分表来说最难的在于事务性和持久化，分布式事务到最后都会用到消息队列，把事务的业务逻辑都丢到消息里面去，然后消费线程慢慢去消费，如果出错了就回滚

快递行业就很适合用中间件，快递行业没有很强的事务性要求，它就是一个个运单，运单需要中转几次，中转状态是什么